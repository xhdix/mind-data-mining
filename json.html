<!DOCTYPE html>
<html>
<head >
    <meta charset="utf-8">
    <title>ooni json</title>
    <style>

    </style>
    <script>
        async function addInputsWithIp (url, http3, hostName, json) {
            try {
                answers = json["Answer"];
                for (let i = 0; i < answers.length; i++) {
                    ip = answers[i]["data"];
                    inputs.innerHTML += '<textarea rows="3" cols="100" class="input">' 
                        + '{"name": "dns_check", "input": "'
                        + url.replace(hostName,ip)
                        + '", "dns_check":{"domain": "x.org", "http_host": "'
                        + hostName
                        + '", "tls_server_name": "'
                        + hostName
                        + '"'
                        + http3
                        + '}}'
                        + '</textarea><br><br>';
                }
            }catch(e) {
                console.log("answer for:" + hostName,  e.message);
            }
        };

        async function resolveIp (url, http3, hostName) {
            setTimeout( async function(){
                var response = await fetch('https://dns.google/resolve?name='
                + hostName + '&type=A' );
                var json = await response.json();
                console.log(json);
                await addInputsWithIp(url, http3, hostName, json);
                setTimeout( async function(){
                    var response = await fetch('https://dns.google/resolve?name='
                    + hostName + '&type=AAAA' );
                    var json = await response.json();
                    console.log(json);
                    await addInputsWithIp(url, http3, hostName, json);
                },3000);
            },3000);
        };

        async function addinputs(url){
            matches = url.match(/^(([a-z0-9]+)?\:\/\/)(([^:\/?#]*)(?:\:([0-9]+))?)([\/]{0,1}[^?#]*)(\?([^\?][^#]*)[^#]*|)(#.*|)$/);
            console.log(matches);
            protoFull = matches && matches[1];
            console.log(protoFull);
            proto = matches && matches[2];
            console.log(proto);
            hostNamePort = matches && matches[3];
            console.log(hostNamePort);
            hostName = matches && matches[4];
            console.log(hostName);
            path = matches && matches[6];
            console.log(path);
            querys = matches && matches[8];
            console.log(querys);
            if ( proto == 'https' || proto == 'http3' || proto == 'dot' ) {
                inputs.innerHTML += '<textarea rows="3" cols="100" class="input">' 
                    + '{"name": "dns_check", "input": "udp://8.8.8.8"'
                    + ', "dns_check":{"domain": "'
                    + hostName
                    + '"}}'
                    + '</textarea><br><br>'; 
                inputs.innerHTML += '<textarea rows="3" cols="100" class="input">' 
                    + '{"name": "dns_check", "input": "udp://9.9.9.9"'
                    + ', "dns_check":{"domain": "'
                    + hostName
                    + '"}}'
                    + '</textarea><br><br>'; 
                
                http3 = "";
                if (proto == 'http3') {
                    http3 = ',"http3_enabled":true'
                    url.replace("http3://", "https://")
                }
                if (RegExp("^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$").test(hostName)) {
                    inputs.innerHTML += '<textarea rows="3" cols="100" class="input">' 
                        + '{"name": "dns_check", "input": "'
                        + url 
                        + '", "dns_check":{"domain": "x.org"'
                        + http3
                        + '}}'
                        + '</textarea><br><br>'; 
                }else {
                    inputs.innerHTML += '<textarea rows="3" cols="100" class="input">' 
                        + '{"name": "dns_check", "input": "'
                        + url 
                        + '", "dns_check":{"domain": "x.org", "http_host": "'
                        +  hostName
                        + '"'
                        + http3
                        + '}}'
                        + '</textarea><br><br>';
                    
                    await resolveIp(url, http3, hostName);
                }
                
            }else if ( proto == 'udp' || proto == 'tcp' ){
                if (querys != null) {
                    inputs.innerHTML += '<textarea rows="3" cols="100" class="input">' 
                        + '{"name": "dns_check", "input": "'
                        + protoFull + hostNamePort 
                        + '", "dns_check":{"domain": "x.org"}}'
                        + '</textarea><br><br>'; 

                    querysArray = querys.split(/&/g);
                    querysArray.forEach( query => {
                        domains = query.match(/([^=]+)=([^=]+)/);
                        if (domains[1] == "domain") {
                            inputs.innerHTML += '<textarea rows="3" cols="100" class="input">' 
                                + '{"name": "dns_check", "input": "'
                                + protoFull + hostNamePort  
                                + '", "dns_check":{"domain": "'
                                + domains[2]
                                + '"}}'
                                + '</textarea><br><br>'; 
                        }
                    
                    });
                }else {
                    inputs.innerHTML += '<textarea rows="3" cols="100" class="input">' 
                        + '{"name": "dns_check", "input": "'
                        + url 
                        + '", "dns_check":{"domain": "x.org"}}'
                        + '</textarea><br><br>'; 
                }
            }
        };

        function parseurls (urlslist) {
            urlslist.forEach( async (url) => {
                if (url != "" ){
                    await addinputs(url);
                }
            });
        }

        function pasteurl(t,e) {
            urlslist = (e.clipboardData || window.clipboardData)
                .getData('text')
                .replace(/^(?=\n)$|^\s*|\s*$|\n\n+/gm,"")
                .split(/\r\n|\r|\n/g);
            console.log(urlslist);
            parseurls(urlslist);
            e.preventDefault();
            t.innerText = "well done :D"
        };
    </script>
</head>
<body>
    
<div>
    <div id="inputs">
        <p contenteditable="true" onPaste="pasteurl(this,event)" > \o/ paste here...</p>
        <br><br>
        <!-- <input class="input" vol=3 value=""/> -->
        <!-- <textarea rows="3" cols="100" class="input"></textarea> -->
    </div>
    <br>
    <button name="generate" onclick="generateoutput()">generate</button>
    <br><br>
    <p id="output" contenteditable="true" style="visibility:hidden;"></p>
    <br><br>
</div>
<script>
    function generateoutput() {
        outputText = "";
        output.innerText = "";
        output.style.visibility= "visible";
        let textareas = inputs.getElementsByTagName("textarea");
        for (let textarea of textareas) {
            outputText += textarea.value;
            outputText +=  "\n";
            output.innerText = outputText;
        }

    }

</script>

</body>
</html>
